# ============================================
# Neanelu Shopify - Docker Compose Development Override
# ============================================
# Override-uri specifice pentru dezvoltare locală
# Expune porturi, activează debug, etc.
#
# Utilizare: docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d
# Sau simplu: pnpm db:up
#
# COMPOSE WATCH (Docker Compose 2.22+):
# docker compose -f docker-compose.yml -f docker-compose.dev.yml watch
# Sincronizează automat fișierele și rebuilduiește când e necesar

services:
  # ============================================
  # Backend API (Fastify) - Development Override
  # ============================================
  backend-worker:
    ports:
      - '${BACKEND_HOST_PORT:-65000}:${PORT:-65000}'
    volumes:
      - .:/app
    develop:
      watch:
        # Sync source files - instant sync without rebuild
        - path: ./apps/backend-worker/src
          action: sync
          target: /app/apps/backend-worker/src
        - path: ./packages
          action: sync
          target: /app/packages
          ignore:
            - node_modules/
        # Rebuild on package.json or config changes
        - path: ./apps/backend-worker/package.json
          action: rebuild
        - path: ./package.json
          action: rebuild
        - path: ./pnpm-lock.yaml
          action: rebuild
        - path: ./apps/backend-worker/tsconfig.json
          action: rebuild

  # ============================================
  # Frontend Web Admin - Development Override
  # ============================================
  web-admin:
    volumes:
      - .:/app
    develop:
      watch:
        # Sync source files - Vite HMR will handle updates
        - path: ./apps/web-admin/app
          action: sync
          target: /app/apps/web-admin/app
        - path: ./apps/web-admin/components
          action: sync
          target: /app/apps/web-admin/components
        - path: ./apps/web-admin/public
          action: sync
          target: /app/apps/web-admin/public
        - path: ./apps/web-admin/types
          action: sync
          target: /app/apps/web-admin/types
        # Rebuild on package.json, config, or index.html changes
        - path: ./apps/web-admin/package.json
          action: rebuild
        - path: ./apps/web-admin/index.html
          action: rebuild
        - path: ./apps/web-admin/vite.config.ts
          action: rebuild
        - path: ./apps/web-admin/tailwind.config.ts
          action: rebuild
        - path: ./package.json
          action: rebuild
        - path: ./pnpm-lock.yaml
          action: rebuild

  # ============================================
  # Bull Board - Placeholder (future)
  # ============================================
  bull-board:
    ports:
      - '65032:65032'
  # ============================================
  # PostgreSQL - Development Override
  # ============================================
  db:
    ports:
      - '65010:5432'
    environment:
      # Log toate statement-urile în dev pentru debugging
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
    # Override command pentru logare extinsă în dev
    command: >
      postgres
      -c shared_buffers=256MB
      -c work_mem=64MB
      -c maintenance_work_mem=128MB
      -c effective_cache_size=512MB
      -c max_connections=200
      -c log_statement=all
      -c log_min_duration_statement=100
      -c log_connections=on
      -c log_disconnections=on

  # ============================================
  # Redis - Development Override
  # ============================================
  redis:
    ports:
      - '65011:6379'

  # ============================================
  # Jaeger - Development Override
  # ============================================
  jaeger:
    ports:
      # UI Web Jaeger
      - '65020:16686'
      # OTLP gRPC
      - '65021:4317'

  # ============================================
  # OpenTelemetry Collector - Development Override
  # ============================================
  otel-collector:
    ports:
      # OTLP HTTP (App -> Collector)
      - '65022:4318'

  # ============================================
  # Loki - Development Override
  # ============================================
  loki:
    ports:
      - '65023:3100'

  # ============================================
  # Grafana - Development Override
  # ============================================
  grafana:
    ports:
      - '65024:3000'

  # ============================================
  # Prometheus - Development Override
  # ============================================
  prometheus:
    ports:
      - '65025:9090'

  # ============================================
  # pgAdmin 4 - GUI pentru PostgreSQL (opțional, doar dev)
  # ============================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: neanelu_pgadmin
    restart: unless-stopped
    ports:
      - '65030:80'
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - neanelu_network
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'wget -qO- http://127.0.0.1/misc/ping >/dev/null 2>&1']
      interval: 10s
      timeout: 3s
      retries: 15
      start_period: 30s

  # ============================================
  # Redis Commander - GUI pentru Redis (opțional, doar dev)
  # ============================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: neanelu_redis_commander
    restart: unless-stopped
    ports:
      - '65031:8081'
    environment:
      REDIS_HOSTS: local:redis:6379
    networks:
      - neanelu_network
    depends_on:
      - redis
    healthcheck:
      test: ['CMD-SHELL', 'wget -qO- http://127.0.0.1:8081/ >/dev/null 2>&1']
      interval: 10s
      timeout: 3s
      retries: 15
      start_period: 20s

# ============================================
# VOLUMES (doar dev - pentru GUI tools)
# ============================================
volumes:
  pgadmin_data:
    name: neanelu_pgadmin_data
