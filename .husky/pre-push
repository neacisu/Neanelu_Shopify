#!/bin/sh
# ============================================
# PRE-PUSH HOOK (Husky 9+ format)
# ============================================

# Get the directory where the repo root is (where .env should be)
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Source environment variables from .env if it exists
if [ -f "$REPO_ROOT/.env" ]; then
  # Do NOT `source` .env directly: syntax errors in .env will hard-fail the hook.
  # Instead, load only simple KEY=VALUE lines.
  while IFS= read -r line; do
    case "$line" in
      ''|\#*) continue ;;
    esac

    case "$line" in
      [A-Za-z_]*=*)
        key=${line%%=*}
        value=${line#*=}
        case "$key" in
          *[!A-Za-z0-9_]* ) continue ;;
        esac
        export "$key=$value"
        ;;
    esac
  done < "$REPO_ROOT/.env"
fi

if [ "${SKIP_PREPUSH:-}" = "1" ]; then
  echo 'â­ï¸  SKIP_PREPUSH=1 set; skipping pre-push tests.'
  exit 0
fi

echo 'ðŸ§ª Running tests before push...'
pnpm test || {
  echo 'âŒ Tests failed! Push aborted.'
  echo 'Run "pnpm test" to see failures.'
  exit 1
}

echo 'âœ… All tests passed! Pushing...'
