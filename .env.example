# ============================================
# Neanelu Shopify - Environment Variables Template
# ============================================
# INSTRUCȚIUNI:
# 1. Copiază acest fișier în .env (care NU se comite)
# 2. Completează valorile reale
# 3. Pentru staging/prod, secretele vin din OpenBAO (secret manager)
#
# ROTAȚIE CHEI: Trimestrială pentru token-uri externe (Shopify, BullMQ, OpenAI)
# și chei AES. Documentație completă în Docs/DevOps_Plan_Implementare_Shopify_Enterprise.md

# ============================================
# DOCKER COMPOSE
# ============================================
# Use both compose files by default (base + dev override with exposed ports)
# This ensures ports like 65010 (PostgreSQL) are exposed for local testing
COMPOSE_FILE=docker-compose.yml:docker-compose.dev.yml

# ============================================
# DATABASE (PostgreSQL 18.1)
# ============================================
# Conexiune runtime (rol app_runtime cu permisiuni limitate)
DATABASE_URL=postgresql://app_runtime:password@localhost:65010/neanelu_shopify

# Conexiune migrații (rol app_migrator cu permisiuni DDL)
DATABASE_URL_MIGRATE=postgresql://app_migrator:password@localhost:65010/neanelu_shopify

# Pool sizing (vezi Plan_de_implementare F2.1.1 pentru recomandări)
# Dev: 10, Staging/Prod: 5 (cu 10 worker containers = 50+ conexiuni totale)
DB_POOL_SIZE=10

# ============================================
# REDIS 8.4 (Cache, Cozi, Vector Search)
# ============================================
REDIS_URL=redis://localhost:65011

# ============================================
# SHOPIFY API
# ============================================
SHOPIFY_API_KEY=your_api_key_here
SHOPIFY_API_SECRET=your_api_secret_here

# Local OAuth helper (oauth-callback-server.ts)
# (În practică pot fi aceleași ca SHOPIFY_API_KEY/SECRET)
SHOPIFY_CLIENT_ID=your_api_key_here
SHOPIFY_CLIENT_SECRET=your_api_secret_here
SHOPIFY_REDIRECT_URI=https://your-domain.com/auth/callback

# Admin API version (default: 2025-10). Fallback handling lives in @app/config.
SHOPIFY_API_VERSION=2025-10

# Scopes necesare pentru aplicație (lista completă)
SCOPES=read_products,write_products,read_orders,read_inventory,write_inventory,read_fulfillments,read_price_rules,read_discounts

# Pentru embedded app (opțional, dacă nu ești embedded lasă gol)
SHOPIFY_APP_URL=https://your-app-domain.com

# ============================================
# RESEARCH (optional)
# ============================================
# Folosit de scripturile din "Research Produse" / "Research Categorii".
# SHOPIFY_SHOP_DOMAIN este domeniul store-ului (ex: your-store.myshopify.com)
SHOPIFY_SHOP_DOMAIN=your-store.myshopify.com

# Admin API access token (din instalarea aplicației pe store)
SHOPIFY_ADMIN_API_TOKEN=your_admin_api_token_here

# ============================================
# BULLMQ PRO (Registry privat + Runtime License)
# ============================================
# Token pentru npm registry privat Taskforce.sh (folosit de pnpm install)
NPM_TASKFORCESH_TOKEN=your_bullmq_pro_npm_token

# Token de licență runtime BullMQ Pro (folosit în cod)
BULLMQ_PRO_TOKEN=your_bullmq_pro_license_token

# ============================================
# OPENAI / AI ENGINE
# ============================================
OPENAI_API_KEY=your_openai_api_key

# Model pentru embeddings (default: text-embedding-3-small)
OPENAI_EMBEDDING_MODEL=text-embedding-3-small

# OpenAI Batch orchestration (PR-048)
# Max items per batch JSONL (default: 1000)
OPENAI_BATCH_MAX_ITEMS=1000
# Poll interval for batch status in seconds (default: 3600)
OPENAI_BATCH_POLL_SECONDS=3600
# Retention for OpenAI files in days (default: 30)
OPENAI_BATCH_RETENTION_DAYS=30
# Scheduler tick for AI batch orchestration in seconds (default: 60)
OPENAI_BATCH_SCHEDULE_TICK_SECONDS=60
# Max retries per embedding item before DLQ (default: 3)
OPENAI_EMBEDDING_MAX_RETRIES=3
# Global kill switch for embeddings backfill (default: true)
OPENAI_EMBEDDING_BACKFILL_ENABLED=true
# Daily budget for embedding items (default: 100000)
OPENAI_EMBEDDING_DAILY_BUDGET=100000

# Embedding rate limiter (token bucket)
# Tokens per minute (default: 1000000)
OPENAI_EMBED_RATELIMIT_TOKENS_PER_MIN=1000000
# Requests per minute (default: 3000)
OPENAI_EMBED_RATELIMIT_REQUESTS_PER_MIN=3000
# Bucket TTL in ms (default: 120000)
OPENAI_EMBED_RATELIMIT_BUCKET_TTL_MS=120000

# Backfill throttling (per shop / global)
OPENAI_EMBED_THROTTLE_SHOP_HOURLY=1000
OPENAI_EMBED_THROTTLE_SHOP_DAILY=10000
OPENAI_EMBED_THROTTLE_GLOBAL_HOURLY=10000

# Max concurrent global OpenAI batches
OPENAI_BATCH_MAX_GLOBAL=5

# Vector search cache and query guardrails
VECTOR_SEARCH_CACHE_TTL_SECONDS=3600
VECTOR_SEARCH_QUERY_TIMEOUT_MS=5000

# Embedding dimensions override (default: 2000 for text-embedding-3-large)
OPENAI_EMBEDDING_DIMENSIONS=2000

# ============================================
# SERPER API (External Product Search)
# ============================================
# API Key de la serper.dev (2500 queries gratuite)
SERPER_API_KEY=your_serper_api_key

# Rate limiting (requests per second)
SERPER_RATE_LIMIT_PER_SECOND=10

# Caching TTL (seconds) - 24 ore
SERPER_CACHE_TTL_SECONDS=86400

# Daily budget (number of requests)
SERPER_DAILY_BUDGET=1000

# Budget alert threshold (0.8 = 80%)
SERPER_BUDGET_ALERT_THRESHOLD=0.8

# Interval verificare conexiune Serper (secunde)
SERPER_HEALTH_CHECK_INTERVAL_SECONDS=3600

# Interval verificare conexiune OpenAI (secunde)
OPENAI_HEALTH_CHECK_INTERVAL_SECONDS=3600

# Interval verificare conexiune xAI (secunde)
XAI_HEALTH_CHECK_INTERVAL_SECONDS=3600

# ============================================
# SECURITY & ENCRYPTION
# ============================================
# Cheie AES-256-GCM pentru criptare token-uri Shopify în DB
# Generare: openssl rand -hex 32
ENCRYPTION_KEY_256=your_64_char_hex_key_here_must_be_exactly_64_chars

# Suport rotație chei (backward compatibility)
# La rotație, adaugă ENCRYPTION_KEY_V2 și schimbă VERSION la 2
ENCRYPTION_KEY_VERSION=1
# ENCRYPTION_KEY_V1=first_64_char_hex_key
# ENCRYPTION_KEY_V2=new_64_char_hex_key_after_rotation

# ============================================
# APPLICATION
# ============================================
# URL-ul public al aplicației (pentru OAuth callback, webhooks)
APP_HOST=https://localhost:65000

# Hostname only (no scheme). Folosit de Traefik Host() rules.
APP_HOSTNAME=localhost

# ============================================
# TRAEFIK (TLS/ACME + Dashboard)
# ============================================
# Email folosit de Let's Encrypt (ACME)
TRAEFIK_ACME_EMAIL=dev@local

# Cert resolver name (Traefik static config uses this)
TRAEFIK_CERT_RESOLVER=letsencrypt

# Porturile expuse pe host (default 80/443)
TRAEFIK_HTTP_PORT=80
TRAEFIK_HTTPS_PORT=443

# Traefik dashboard basic-auth users (format: user:hashedPassword)
# Generează hash (bcrypt) astfel:
#   docker run --rm httpd:2.4-alpine htpasswd -nbB admin 'PAROLA_TA'
# IMPORTANT: în fișierele .env, Docker Compose poate interpreta `$` pentru substituții.
# Pentru hash-urile bcrypt (care conțin `$`), dublează `$` -> `$$` în valoare.
# Setează aici utilizatorii pentru Traefik dashboard (basic auth).
# Exemplu (după ce generezi bcrypt):
#   TRAEFIK_DASHBOARD_USERS=admin:$$2y$$05$$...  (atenție: dublează $ -> $$)
TRAEFIK_DASHBOARD_USERS=

# Mediul curent: development | staging | production
NODE_ENV=development

# Nivel de logging: debug | info | warn | error
LOG_LEVEL=debug

# Port pentru server (default: 3000)
PORT=65000

# Port intern pentru frontend container (doar dacă ai nevoie să-l schimbi)
FRONTEND_PORT=65001

# Dacă portul ${PORT} e ocupat pe host, poți schimba portul public expus (dev override)
BACKEND_HOST_PORT=65000

# ============================================
# QUEUE FAIRNESS (PR-022 / F4.2)
# ============================================
# Concurență globală worker (job slots totale per proces)
MAX_GLOBAL_CONCURRENCY=50

# Concurență maximă per shop (BullMQ Pro Groups)
MAX_ACTIVE_PER_SHOP=2

# Prag de protecție anti-starvation (folosit în teste / tuning)
STARVATION_TIMEOUT_MS=60000

# ============================================
# BULK INGESTION TUNING (F5.2.5-F5.2.8)
# ============================================
# Concurență best-effort pentru download / COPY
MAX_CONCURRENT_DOWNLOADS=2
MAX_CONCURRENT_COPIES=2
MAX_GLOBAL_INGESTION=10

# Batching COPY
BULK_COPY_BATCH_ROWS=25000
BULK_COPY_BATCH_BYTES=33554432

# Download stream buffer
BULK_DOWNLOAD_HIGH_WATERMARK_BYTES=1048576

# Merge behavior
BULK_MERGE_ANALYZE=true
BULK_MERGE_ALLOW_DELETES=false
BULK_STAGING_REINDEX=true

# ============================================
# OBSERVABILITY (OpenTelemetry)
# ============================================
# Endpoint OTLP pentru export spans/metrics (Jaeger în dev, Grafana Tempo în prod)
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:65022

# Numele serviciului în traces
OTEL_SERVICE_NAME=neanelu-shopify

# Sampling ratio (1.0 = toate, 0.1 = 10% în prod pentru cost)
# OTEL_SAMPLING_RATIO este documentat mai jos în secțiunea "OBSERVABILITY EXTENDED".

# ============================================
# DOCKER COMPOSE (pentru servicii locale)
# ============================================
# Aceste variabile sunt folosite de docker-compose.yml
POSTGRES_USER=shopify
POSTGRES_PASSWORD=shopify_dev_password
POSTGRES_DB=neanelu_shopify

# URL-uri interne (folosite DOAR de containere)
DATABASE_URL_DOCKER=postgresql://shopify:shopify_dev_password@db:5432/neanelu_shopify
REDIS_URL_DOCKER=redis://redis:6379

# OpenTelemetry (folosit de containere; collector în rețeaua docker)
OTEL_EXPORTER_OTLP_ENDPOINT_DOCKER=http://otel-collector:4318

# pgAdmin (doar în dev override)
PGADMIN_EMAIL=admin@local.dev
PGADMIN_PASSWORD=admin

# ============================================
# OBSERVABILITY EXTENDED (CONFORM Problems & Fixes.md + F3.4.5)
# ============================================
# OpenTelemetry configuration per environment.
# Vezi Docs/Metrics_Reference.md pentru lista completă de metrici.
#
# === Development (current) ===
# OTEL_SAMPLING_RATIO=1.0          # 100% traces
# LOG_LEVEL=debug
# OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:65022
# OBS_DEBUG=1                       # verbose OTel diagnostics
#
# === Staging ===
# OTEL_SAMPLING_RATIO=0.5          # 50% traces
# LOG_LEVEL=info
# OBS_DEBUG=0
#
# === Production ===
# OTEL_SAMPLING_RATIO=0.1          # 10% traces
# LOG_LEVEL=warn
# OTEL_ERROR_SAMPLING=1.0          # 100% pentru erori
# OBS_DEBUG=0
#
# === CI (OTel disabled) ===
# OTEL_EXPORTER_OTLP_ENDPOINT=     # gol = tracing dezactivat
# OTEL_SAMPLING_RATIO=0

# Current Environment Settings:
OTEL_SAMPLING_RATIO=1.0

# Error sampling (always 100% pentru erori indiferent de mediu)
OTEL_ERROR_SAMPLING=1.0

# Diagnostic mode (1 = verbose OTel logs, 0 = silent)
OBS_DEBUG=0

# ============================================
# LOKI + GRAFANA STACK
# ============================================
LOKI_VERSION=3.6.3
GRAFANA_VERSION=12.3.1
OTEL_COLLECTOR_VERSION=0.142.0

# Grafana credentials (SCHIMBĂ ÎN PRODUCȚIE!)
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=changeme_in_production

# Ports (conform range 65xxx)
LOKI_PORT=65023
GRAFANA_PORT=65024

# Loki retention (744h = 31 zile)
LOKI_RETENTION_PERIOD=744h




# ============================================
# DATABASE BOOTSTRAP (F2.1.2.2)
# ============================================
# Variabile pentru scripts/db-bootstrap.sh
# ⚠️ TOATE sunt OBLIGATORII - scriptul eșuează fără ele!
# În producție, toate vin din secret manager (OpenBAO/Vault)

# Numele rolului pentru migrații (DDL operations)
MIGRATOR_ROLE_NAME=<numele_rolului_migrator>

# Numele rolului pentru runtime (DML operations)
RUNTIME_ROLE_NAME=<numele_rolului_runtime>

# Parola pentru rolul migrator
# ⚠️ SCHIMBĂ ACEASTA!
MIGRATION_DB_PASSWORD=<parola_din_secret_manager>

# Parola pentru rolul runtime
# ⚠️ SCHIMBĂ ACEASTA!
RUNTIME_DB_PASSWORD=<parola_din_secret_manager>

# Parola superuser PostgreSQL (pentru bootstrap)
# ⚠️ SCHIMBĂ ACEASTA! În Docker dev, trebuie să coincidă cu POSTGRES_PASSWORD
POSTGRES_SUPERUSER_PASSWORD=<parola_din_secret_manager>

# DB bootstrap connection (dev defaults). DB_NAME este obligatoriu.
DB_HOST=localhost
DB_PORT=65010
DB_NAME=neanelu_shopify
